<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Search Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .multi-select {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 0.375rem 0.75rem;
            min-height: 38px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            cursor: pointer;
            background-color: #fff;
        }

        .multi-select .tag {
            background-color: #0d6efd;
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            margin: 2px;
            display: flex;
            align-items: center;
        }

        .multi-select .tag .remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .multi-select-dropdown {
            position: absolute;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            background-color: #fff;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            display: none;
        }

        .multi-select-dropdown div {
            padding: 5px 10px;
            cursor: pointer;
        }

        .multi-select-dropdown div:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
<div class="container py-5 d-flex flex-column align-items-center">

    <!-- Search Form -->
    <div class="card p-4 mb-4" style="min-width: 300px; max-width: 500px; width: 100%;">
        <h4 class="card-title text-center mb-3">Search</h4>
        <form id="searchForm" th:action="@{/search}" method="get">
            <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate" name="startDate"
                       th:value="${startDate}">
            </div>
            <div class="mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDate" name="endDate"
                       th:value="${endDate}">
            </div>


            <div class="multi-select-wrapper" data-name="pids">
                <div class="multi-select">Select tags...</div>
                <div class="multi-select-dropdown">
                    <div th:each="project : ${allProjects}" th:attr="data-id=${project.projectID}" th:text="${project.name}"></div>
                </div>
            </div>

            <div class="multi-select-wrapper" data-name="oids">
                <div class="multi-select">Select status...</div>
                <div class="multi-select-dropdown">
                    <div th:each="object : ${allObjects}" th:attr="data-id=${object.objectID}" th:text="${object.name}"></div>
                </div>
            </div>


            <div class="text-center">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>


        </form>
    </div>

    <!-- Results -->
    <div th:if="${results != null}" class="w-100 d-flex justify-content-center flex-column align-items-center">
        <ul class="list-group mb-3" style="min-width: 300px; max-width: 500px; width: 100%;">
            <li class="list-group-item" th:each="item : ${results}" th:text="${item.mainHeader}"></li>
        </ul>
        <div th:if="${results.isEmpty()}" class="alert alert-info text-center" style="width: 100%; max-width: 500px;">
            No results found.
        </div>
    </div>

</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('searchForm');
        if (!form) return;

        // Loop through all multi-select wrappers
        document.querySelectorAll('.multi-select-wrapper').forEach(wrapper => {
            const selectBox = wrapper.querySelector('.multi-select');
            const dropdown = wrapper.querySelector('.multi-select-dropdown');
            const paramName = wrapper.dataset.name;
            const selected = new Set();

            if (!selectBox || !dropdown || !paramName) return;

            // Toggle dropdown on click
            selectBox.addEventListener('click', e => {
                e.stopPropagation();
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });

            // Select/deselect items
            dropdown.querySelectorAll('div').forEach(item => {
                item.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = item.dataset.id
                    const value = {id: id, text: item.textContent};
                    if (selected.has(value)) {
                        selected.delete(value);
                    } else {
                        selected.add(value);
                    }
                    renderTags();
                });
            });

            // Render tags + hidden inputs
            function renderTags() {
                selectBox.innerHTML = '';
                form.querySelectorAll(`input[name="${paramName}"]`).forEach(i => i.remove());

                if (selected.size === 0) {
                    selectBox.textContent = `Select ${paramName}...`;
                } else {
                    selected.forEach(val => {
                        // Tag for UI
                        const tag = document.createElement('span');
                        tag.className = 'tag';
                        tag.textContent = val.text;

                        const remove = document.createElement('span');
                        remove.className = 'remove';
                        remove.textContent = 'Ã—';
                        remove.onclick = e => {
                            e.stopPropagation();
                            selected.delete(val);
                            renderTags();
                        };
                        tag.appendChild(remove);
                        selectBox.appendChild(tag);

                        // Hidden input for form submission
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = paramName;
                        input.value = val.id;
                        form.appendChild(input);
                    });
                }
            }
        });

        // Close all dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.multi-select-dropdown').forEach(dd => dd.style.display = 'none');
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
