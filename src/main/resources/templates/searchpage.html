<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Search Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .multi-select {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 0.375rem 0.75rem;
            min-height: 38px;
            min-width: 200px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            cursor: pointer;
            background-color: #fff;
        }

        .multi-select .tag {
            background-color: #0d6efd;
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            margin: 2px;
            display: flex;
            align-items: center;
        }

        .multi-select .tag .remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .multi-select-dropdown {
            position: absolute;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            background-color: #fff;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            display: none;
        }

        .multi-select-dropdown div {
            padding: 5px 10px;
            cursor: pointer;
        }

        .multi-select-dropdown div:hover {
            background-color: #e9ecef;
        }


        .result-container{
          width: 100%;
        }
    </style>
</head>
<body>
<div class="container py-5 d-flex flex-column align-items-center">

    <!-- Search Form -->
    <div class="container-fluid py-4">
        <form id="searchForm" th:action="@{/search}" method="get">

            <div class="row g-4">

                <!-- Start Date -->
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" name="startDate"
                           th:value="${startDate}">
                </div>

                <!-- End Date -->
                <div class="col-md-3">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate"
                           th:value="${endDate}">
                </div>

                <!-- Projekte -->
                <div class="col-md-3">
                    <label class="form-label">Projekte</label>
                    <div class="multi-select-wrapper" data-description="Projekte" data-name="pids"
                         style="position: relative;">
                        <div class="multi-select"></div>
                        <div class="multi-select-dropdown">
                            <div th:each="project : ${allProjects}"
                                 th:attr="data-id=${project.projectID}"
                                 th:text="${project.name}"
                                 th:data-selected="${selectedPids.contains(project.projectID)} ? true : false">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Produktionsflächen -->
                <div class="col-md-3">
                    <label class="form-label">Produktionsflächen</label>
                    <div class="multi-select-wrapper" data-description="Produktionsflächen" data-name="oids"
                         style="position: relative;">
                        <div class="multi-select"></div>
                        <div class="multi-select-dropdown">
                            <div th:each="object : ${allObjects}"
                                 th:attr="data-id=${object.objectID}"
                                 th:text="${object.name}"
                                 th:data-selected="${selectedOids.contains(object.objectID)} ? true : false">
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>

        </form>
    </div>

    <div th:if="${results != null}" class="container-fluid py-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle w-100">
                <thead class="table-light">
                <tr>
                    <th style="width: 15%;">Startzeit</th>
                    <th style="width: 15%;">Endzeit</th>
                    <th style="width: 25%;">Buchungstitel</th>
                    <th style="width: 15%;">Objekte</th>
                    <th style="width: 10%;">Moderatoren</th>
                    <th style="width: 10%;">Arten</th>
                    <th style="width: 10%;">Notizen</th>

                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${results}">
                    <td th:text="${item.dateTimeInAsString}"></td>
                    <td th:text="${item.dateTimeOutAsString}"></td>
                    <td th:text="${item.entryHeader}"></td>
                    <td th:text="${#strings.listJoin(item.objectNames, ', ')}"></td>
                    <td th:text="${#strings.listJoin(item.customModerators, ', ')}"></td>
                    <td th:text="${#strings.listJoin(item.customArts, ', ')}"></td>
                    <td th:text="${#strings.listJoin(item.notes, ', ')}"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div th:if="${results.isEmpty()}" class="alert alert-info text-center mt-3">
        No results found.
    </div>
</div>


</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('searchForm');
        if (!form) return;

        document.querySelectorAll('.multi-select-wrapper').forEach(wrapper => {
            const selectBox = wrapper.querySelector('.multi-select');
            const dropdown = wrapper.querySelector('.multi-select-dropdown');
            const paramName = wrapper.dataset.name;
            const description = wrapper.dataset.description;
            const selected = new Set();

            if (!selectBox || !dropdown || !paramName) return;

            // Make the selectBox editable with input
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = `Wählen Sie ein oder mehrere ${description} aus...`;
            input.style.border = 'none';
            input.style.outline = 'none';
            input.style.flex = '1';
            input.style.minWidth = '60px';
            input.style.backgroundColor = 'transparent';
            selectBox.innerHTML = ''; // Clear default text
            selectBox.appendChild(input);

            // Function to render tags
            function renderTags() {
                selectBox.innerHTML = '';
                if (selected.size === 0) {
                    input.value = '';
                    input.placeholder = `Wählen Sie ein oder mehrere ${description} aus...`;
                } else {
                    selected.forEach(val => {
                        const tag = document.createElement('span');
                        tag.className = 'tag';
                        tag.textContent = val.text;

                        const remove = document.createElement('span');
                        remove.className = 'remove';
                        remove.textContent = '×';
                        remove.onclick = e => {
                            e.stopPropagation();
                            selected.delete(val);
                            renderTags();
                        };
                        tag.appendChild(remove);
                        selectBox.appendChild(tag);
                    });
                }
                selectBox.appendChild(input);

                // Hidden inputs for form submission
                form.querySelectorAll(`input[name="${paramName}"]`).forEach(i => i.remove());
                selected.forEach(val => {
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = paramName;
                    hidden.value = val.id;
                    form.appendChild(hidden);
                });
            }

            // Toggle dropdown
            selectBox.addEventListener('click', e => {
                e.stopPropagation();
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                input.focus();
            });

            // Filter dropdown based on input
            input.addEventListener('input', () => {
                const filter = input.value.toLowerCase();
                let anyVisible = false;
                dropdown.querySelectorAll('div').forEach(item => {
                    if (item.textContent.toLowerCase().includes(filter)) {
                        item.style.display = 'block';
                        anyVisible = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                dropdown.style.display = anyVisible ? 'block' : 'none';
            });

            // Click on dropdown item
            dropdown.querySelectorAll('div').forEach(item => {
                if (item.dataset.selected === 'true') {
                  selected.add({id: item.dataset.id, text: item.textContent});
                }

                item.addEventListener('click', e => {
                    e.stopPropagation();
                    const val = {id: item.dataset.id, text: item.textContent};
                    selected.add(val);
                    renderTags();
                    input.value = '';
                    input.focus();
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                dropdown.style.display = 'none';
            });

            // Initial render
            renderTags();
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
